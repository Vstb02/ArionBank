@page "/Credit"
@using ArionBank.Account.Service.Card
@using ArionBank.Account.Service.Credit
@using ArionBank.Application.Models
@using System.Security.Claims
@using ArionBank.Domain.Enums
@inject ICardService _cardService
@inject ICreditService _creditService
@inject NavigationManager NavigationManager
<main class="col-lg-8" id="main">
    <div class="h1 text-center" style="margin-top: 50px; font-size: 32px;">Оформление кредита</div>
    <div class="select" style="margin-top: 60px;">
        <EditForm Model="creditModel" OnValidSubmit="CreditHanlder">
            <div style="color: red; text-align: left">
                <DataAnnotationsValidator />
                <ValidationSummary />
            </div>
        <span class="header-credit">Счет</span>
        <select @bind="creditModel.CardId" id="mInput" class="form-select mInput" aria-label="Default select example">
                    <option value="">Выбрать счет</option>
                    @if(cardList.Cards != null)
                    @foreach(var Item in cardList.Cards)
                    {
                        if(Item.Type == TypesCard.Debit)
                        {
                            <option value="@Item.Id">@Item.Number - @Item.PaymentSystem | @Item.Id</option>
                        }
                    }
                </select> 
        <div class="mt-3">
            <span>Сумма, которую вы хотите взять</span>
            <input @bind="creditModel.Ammount" id="mInput" type="text" class="form-control mInput-2">
            <span>Средняя заработная плата</span>
            <input @bind="creditModel.AverageSalary" id="mInput" type="text" class="form-control mInput-2">

             <div class="form-group">
                <span>Место работы</span>
                <InputText type="text" id="mInput" Class="form-control mInput2" @bind-Value="creditModel.PlaceOfWork" />
            </div>
             <div class="form-group">
                <span>Укажите цель кредитаа</span>
                <InputText type="text" id="mInput" Class="form-control mInput2" @bind-Value="creditModel.Purpose" />
            </div>

            <span>На какой срок</span>
            <input @bind="creditModel.Term" id="mInput" type="date" min="@DateTime.Now.Year-@DateTime.Now.Month-@DateTime.Now.Day" class="form-control mInput-2">
            <span class="remark">Процентная ставка по кредиту составляет от 13% до 25%,
                окончательный результат будет сообщен после проверки</span>
            <div @onclick="CreditHanlder" class="btn-custom-2 w-10 mt-2 text-center" style="width: 200px; margin: auto;">Продолжить</div>
        </div>
        </EditForm>
    </div>
</main>

@code {
    CreateCreditModel creditModel = new CreateCreditModel();
    CardListModel cardList = new CardListModel();
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private IEnumerable<string> Error = new List<string>();
    private bool ShowErrors;
    private Guid UserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;
        var user = authState.User;

        string id = string.Empty;
        try
        {
            id = user.Claims.Where(x => x.Type == ClaimTypes.NameIdentifier).FirstOrDefault().Value;
            UserId = Guid.Parse(id);
        }
        catch{
            Error.Append("Произошла непредвиденная ошибка");
            ShowErrors = true;
        }

        cardList = await _cardService.GetCardList(UserId);
    }
    private async Task CreditHanlder()
    {
        var result = await _creditService.CreateCredit(creditModel);

        if (result.Successful)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            Error = result.Errors;
            ShowErrors = true;
        }
    }
}
